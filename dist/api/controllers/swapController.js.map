{"version":3,"file":"swapController.js","names":["test","req","res","send","network","process","env","NETWORK","newSwap","metadata","body","response","db","swaps","create","JSON","stringify","status","init_address","trim","accept_address","init_sign","json","success","message","data","err","console","log","updateSwap","update","where","id","updateSwapStatus","tx","txn","notes","timestamp","getSwapDetails","query","swapId","swap","findByPk","walletId","parse","getPending","findAll","Op","and","or","address","history","sendSign","sign","swapController"],"sources":["../../../src/api/controllers/swapController.js"],"sourcesContent":["import db from \"../../database/models\"\r\nimport { Op } from \"sequelize\"\r\n\r\nfunction test(req, res) {\r\n    //testDb();\r\n    res.send({ network: process.env.NETWORK })\r\n}\r\n\r\nconst newSwap = async (req, res) => {\r\n    try {\r\n        var metadata = req.body.metadata\r\n\r\n        const response = await db.swaps.create({\r\n            metadata: JSON.stringify(metadata),\r\n            status: 1,\r\n            init_address: req.body.init_address.trim(),\r\n            accept_address: req.body.accept_address.trim(),\r\n            init_sign: req.body.init_sign.trim()\r\n        })\r\n        if (response) {\r\n            res.json({\r\n                success: true,\r\n                message: \"new_swap\",\r\n                data: response\r\n            })\r\n        }\r\n    } catch (err) {\r\n        console.log(err)\r\n        res.status(500).json({\r\n            success: false,\r\n            message: `***new_swap error -> ${err}`\r\n        })\r\n    }\r\n}\r\n\r\nconst updateSwap = async (req, res) => {\r\n    try {\r\n        var metadata = req.body.metadata\r\n\r\n        const response = await db.swaps.update(\r\n            {\r\n                metadata: JSON.stringify(metadata),\r\n                status: 1, //1 is pending\r\n                init_address: req.body.init_address.trim(),\r\n                accept_address: req.body.accept_address.trim(),\r\n                init_sign: req.body.init_sign.trim()\r\n            },\r\n            { where: { id: req.body.id } }\r\n        )\r\n\r\n        if (response) {\r\n            res.json({\r\n                success: true,\r\n                message: \"update_swap\",\r\n                data: response\r\n            })\r\n        }\r\n    } catch (err) {\r\n        console.log(err)\r\n        res.status(500).json({\r\n            success: false,\r\n            message: `***update_swap error -> ${err}`\r\n        })\r\n    }\r\n}\r\n\r\nconst updateSwapStatus = async (req, res) => {\r\n    try {\r\n        const response = await db.swaps.update(\r\n            {\r\n                status: req.body.status,\r\n                tx: \"\" + req.body.txn,\r\n                notes: \"\" + req.body.notes,\r\n                metadata: req.body.metadata,\r\n                timestamp: req.body.timestamp\r\n            },\r\n            { where: { id: req.body.id } }\r\n        )\r\n\r\n        if (response) {\r\n            res.json({\r\n                success: true,\r\n                message: \"update_swap_status\",\r\n                data: response\r\n            })\r\n        }\r\n    } catch (err) {\r\n        console.log(err)\r\n        res.status(500).json({\r\n            success: false,\r\n            message: `***update_swap_status -> ${err}`\r\n        })\r\n    }\r\n}\r\n\r\nconst getSwapDetails = async (req, res) => {\r\n    try {\r\n        console.log(req.query.swapId)\r\n        const swap = await db.swaps.findByPk(req.query.swapId)\r\n        if (swap) {\r\n            let walletId = req.query.walletId\r\n            const metadata = JSON.parse(swap.metadata)\r\n            console.log(metadata)\r\n            if (\r\n                swap.init_address !== walletId &&\r\n                swap.accept_address !== walletId\r\n            ) {\r\n                res.status(200).json({\r\n                    success: false,\r\n                    message: \"not authorized to view this swap\"\r\n                })\r\n            } else {\r\n                res.json({\r\n                    success: true,\r\n                    message: \"getSwapDetails\",\r\n                    data: swap\r\n                })\r\n            }\r\n        } else {\r\n            res.status(200).json({\r\n                success: false,\r\n                message: \"swap details not found\"\r\n            })\r\n        }\r\n    } catch (err) {\r\n        console.log(err)\r\n        res.status(500).json({\r\n            success: false,\r\n            message: `***getSwapDetails error -> ${err}`\r\n        })\r\n    }\r\n}\r\n\r\nconst getPending = async (req, res) => {\r\n    try {\r\n        const response = await db.swaps.findAll({\r\n            where: {\r\n                [Op.and]: {\r\n                    status: 1,\r\n                    [Op.or]: [\r\n                        { accept_address: req.query.address },\r\n                        { init_address: req.query.address }\r\n                    ]\r\n                }\r\n            }\r\n        })\r\n        if (response) {\r\n            res.json({\r\n                success: true,\r\n                message: \"get_pending\",\r\n                data: response\r\n            })\r\n        }\r\n    } catch (err) {\r\n        console.log(err)\r\n        res.status(500).json({\r\n            success: false,\r\n            message: `***get_pending error -> ${err}`\r\n        })\r\n    }\r\n}\r\n\r\nconst history = async (req, res) => {\r\n    try {\r\n        const response = await db.swaps.findAll({\r\n            //attributes: [\"createdAt\", \"status\"],\r\n            where: {\r\n                [Op.or]: [\r\n                    { accept_address: req.query.address },\r\n                    { init_address: req.query.address }\r\n                ]\r\n            }\r\n        })\r\n        if (response) {\r\n            res.json({\r\n                success: true,\r\n                message: \"history\",\r\n                data: response\r\n            })\r\n        }\r\n    } catch (err) {\r\n        console.log(err)\r\n        res.status(500).json({\r\n            success: false,\r\n            message: `***history error -> ${err}`\r\n        })\r\n    }\r\n}\r\n\r\nconst sendSign = async (req, res) => {\r\n    try {\r\n        const response = await db.swaps.update(\r\n            { init_sign: req.body.sign },\r\n            { where: { init_address: req.body.address } }\r\n        )\r\n        if (response) {\r\n            res.json({\r\n                success: true,\r\n                message: \"send_sign\",\r\n                data: response\r\n            })\r\n        }\r\n    } catch (err) {\r\n        console.log(err)\r\n        res.status(500).json({\r\n            success: false,\r\n            message: `***send_sign error -> ${err}`\r\n        })\r\n    }\r\n}\r\n\r\nexport const swapController = {\r\n    test,\r\n    newSwap,\r\n    updateSwap,\r\n    updateSwapStatus,\r\n    getPending,\r\n    history,\r\n    sendSign,\r\n    getSwapDetails\r\n}\r\n"],"mappings":"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"}